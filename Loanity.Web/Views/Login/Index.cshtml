@model Loanity.Domain.Dtos.LoginDto

@{
    Layout = null; // Disable layout for login page
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Loanity Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="~/css/loginForm.css" />
</head>
<body>
    <main class="auth-card" role="main" aria-labelledby="title">
        <div class="logo-wrap">
           
            <div class="logo">
                <img src="/img/loanityIcon.png" alt="Loanity" />
            </div>

            <div class="brand">Loanity</div>
        </div>

        <h1 id="title">Log ind</h1>
        <p class="lead">Brug dine skoleoplysninger.</p>
        <input type="hidden" id="IsScanned" name="IsScanned" value="false" />

        <form asp-controller="Login" asp-action="Login" method="post" autocomplete="off" novalidate>
            @Html.AntiForgeryToken()

            <div class="form-grid">
                <div>
                    <label asp-for="RfidChip">RFID</label>
                    <input asp-for="RfidChip" class="input" type="password" placeholder="Scan dit RFID kort" autocomplete="off" aria-describedby="rfid-help"
                           oninput="this.value = this.value.toUpperCase();" />
                    <div id="rfid-help" class="help">dette udfyldes automatisk ved scanning af kort.</div>
                </div>
                <div>
                    <label asp-for="UserName">Brugernavn</label>
                    <input asp-for="UserName" class="input" placeholder="Indtast dit brugernavn" autocomplete="username" required/>
                </div>

                <div>
                    <label asp-for="PassWord">Adgangskode</label>
                    <input asp-for="PassWord"  class="input" type="password" placeholder="Indtast din adgangskode" autocomplete="current-password" required/>
                </div>
                <div class="actions">
                    <span class="subtle">Brug for hjælp? Kontakt IT.</span>
                    <button class="btn" type="submit" id="loginBtn">Bekræft</button>
                </div>
            </div>
        </form>

        <div class="footer">© 2025 Loanity</div>

        @* Error messages except "3x attempts" *@
        @if (ViewData.ModelState.Values.Any(v => v.Errors.Any(e => !e.ErrorMessage.Contains("3x attempts"))))
        {
            <div class="alert alert-danger">
                @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                {
                    if (!error.ErrorMessage.Contains("3x attempts"))
                    {
                        <p>@error.ErrorMessage</p>
                    }
                }
            </div>
        }

        @* Countdown for "Too many login attempts" *@
        @if (ViewData.ModelState.Values.Any(v => v.Errors.Any(e => e.ErrorMessage.Contains("3x attempts"))))
        {
            <div class="alert alert-danger">
                <p id="rateLimitMessage">⏳ For mange loginforsøg. Prøv igen om <span id="countdown">60</span> sekunder.</p>
            </div>

            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    const username = document.getElementById("UserName");
                    const password = document.getElementById("PassWord");
                    const rfid = document.getElementById("RfidChip");
                    const loginBtn = document.getElementById("loginBtn");
                    const countdownDisplay = document.getElementById("countdown");

                    username.disabled = true;
                    password.disabled = true;
                    rfid.disabled = true;
                    loginBtn.disabled = true;

                    let secondsLeft = 60;

                    const timer = setInterval(() => {
                        secondsLeft--;
                        countdownDisplay.textContent = secondsLeft;

                        if (secondsLeft <= 0) {
                            clearInterval(timer);
                            username.disabled = false;
                            password.disabled = false;
                            rfid.disabled = false;
                            loginBtn.disabled = false;

                            document.getElementById("rateLimitMessage").textContent = "✅ Du kan prøve igen nu.";
                        }
                    }, 1000);
                });
            </script>
        }
    </main>
</body>
</html>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const rfidInput = document.getElementById("RfidChip");
        if (rfidInput) {
            rfidInput.focus();
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        const rfidInput = document.getElementById("RfidChip");
        const isScannedInput = document.getElementById("IsScanned");

        let lastTime = 0;
        let typedChars = 0;

        rfidInput.addEventListener("input", function (e) {
            const now = Date.now();
            typedChars++;

            if (lastTime) {
                const diff = now - lastTime;

                if (diff < 30 && typedChars > 5) {
                    // Looks like a fast RFID scan
                    isScannedInput.value = "true";
                } else {
                    // Looks like manual typing
                    isScannedInput.value = "false";
                }
            }
            lastTime = now;
        });
    });
</script>


